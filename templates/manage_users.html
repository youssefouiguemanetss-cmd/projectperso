<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - TSS Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .user-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .perm-chip { transition: all 0.2s ease; }
        .perm-chip.active { background: #4f46e5; color: white; }
        .perm-chip:not(.active) { background: #e5e7eb; color: #374151; }
        .perm-chip:hover { transform: scale(1.05); }
        .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('services') }}" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-users-cog text-indigo-600 mr-2"></i>
                        Manage Users
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="user-badge text-white px-3 py-2 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-circle"></i>
                            <div class="text-sm">
                                <div class="font-semibold">{{ current_user.name }}</div>
                                <div class="text-xs opacity-90">{{ current_user.entity }}</div>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-700">All Users</h2>
                <p class="text-sm text-gray-500">Manage users, permissions, and quotas</p>
            </div>
            <div class="flex items-center space-x-3">
                <input type="text" id="searchInput" placeholder="Search users..." class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-64">
                <button onclick="openAddModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>Add User
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Entity</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Username</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Permissions</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Max Processes</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Domain Quota</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Domains Used</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="userModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="modalMode" value="add">
                <input type="hidden" id="modalTargetUsername" value="">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Entity</label>
                        <input type="text" id="modalEntity" placeholder="e.g. TSS1, TSS2, TSSW" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="modalName" placeholder="Full name" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="modalUsername" placeholder="Username" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="text" id="modalPassword" placeholder="Password" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Permissions</label>
                    <div class="flex flex-wrap gap-2" id="permissionsContainer">
                        {% for perm_key, perm_label in all_permissions %}
                        <button type="button" class="perm-chip px-3 py-1 rounded-full text-xs font-medium cursor-pointer" data-perm="{{ perm_key }}" onclick="togglePerm(this)">
                            {{ perm_label }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-3"><i class="fas fa-rss mr-1"></i> News Subscription Limits</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Max Concurrent Processes</label>
                            <input type="number" id="modalMaxProcesses" min="1" max="100" value="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-yellow-500">
                            <p class="text-xs text-gray-400 mt-1">How many processes they can run at once</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Monthly Domain Quota</label>
                            <input type="number" id="modalDomainQuota" min="0" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-yellow-500">
                            <p class="text-xs text-gray-400 mt-1">0 = unlimited</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                <button onclick="saveUser()" id="modalSaveBtn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Delete User</h3>
                    <p class="text-sm text-gray-600" id="deleteMessage">Are you sure you want to delete this user?</p>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-center space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                <button onclick="confirmDelete()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg">
                    <i class="fas fa-trash mr-1"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-sm font-medium toast"></div>

    <script>
        let allUsers = [];
        let deleteTarget = null;

        const ALL_PERMS = [
            {% for perm_key, perm_label in all_permissions %}
            {key: '{{ perm_key }}', label: '{{ perm_label }}'},
            {% endfor %}
        ];

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-sm font-medium toast';
            t.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500', 'text-white');
            t.textContent = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/manage-users/list');
                const data = await res.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                allUsers = data.users;
                renderTable();
            } catch(e) { showToast('Failed to load users', 'error'); }
        }

        function renderTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(u =>
                u.name.toLowerCase().includes(search) ||
                u.username.toLowerCase().includes(search) ||
                u.entity.toLowerCase().includes(search)
            );
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = filtered.map(u => {
                const permBadges = u.permissions.map(p => {
                    const found = ALL_PERMS.find(x => x.key === p);
                    return `<span class="inline-block bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full text-xs mr-1 mb-1">${found ? found.label : p}</span>`;
                }).join('');
                const quotaInfo = u.domain_quota > 0
                    ? `${u.domains_processed_this_month} / ${u.domain_quota}`
                    : '<span class="text-gray-400">Unlimited</span>';
                const processInfo = u.permissions.includes('infinity-process')
                    ? '<span class="text-indigo-600 font-medium">Unlimited</span>'
                    : u.max_processes;
                return `<tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3"><span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-semibold">${u.entity}</span></td>
                    <td class="px-4 py-3 font-medium text-gray-800">${u.name}</td>
                    <td class="px-4 py-3 text-gray-600">${u.username}</td>
                    <td class="px-4 py-3">${permBadges || '<span class="text-gray-400">None</span>'}</td>
                    <td class="px-4 py-3 text-center">${processInfo}</td>
                    <td class="px-4 py-3 text-center">${u.domain_quota > 0 ? u.domain_quota.toLocaleString() : '<span class="text-gray-400">Unlimited</span>'}</td>
                    <td class="px-4 py-3 text-center">${quotaInfo}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <button onclick='openEditModal(${JSON.stringify(u).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-800 p-1" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="openDeleteModal('${u.username}', '${u.name}')" class="text-red-500 hover:text-red-700 p-1" title="Delete"><i class="fas fa-trash"></i></button>
                            ${u.domain_quota > 0 ? `<button onclick="resetQuota('${u.username}')" class="text-yellow-600 hover:text-yellow-800 p-1" title="Reset Quota"><i class="fas fa-sync-alt"></i></button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);

        function togglePerm(btn) { btn.classList.toggle('active'); }

        function getSelectedPerms() {
            return [...document.querySelectorAll('.perm-chip.active')].map(b => b.dataset.perm);
        }

        function setSelectedPerms(perms) {
            document.querySelectorAll('.perm-chip').forEach(b => {
                b.classList.toggle('active', perms.includes(b.dataset.perm));
            });
        }

        function openAddModal() {
            document.getElementById('modalMode').value = 'add';
            document.getElementById('modalTargetUsername').value = '';
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('modalEntity').value = '';
            document.getElementById('modalName').value = '';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalMaxProcesses').value = '1';
            document.getElementById('modalDomainQuota').value = '0';
            setSelectedPerms([]);
            document.getElementById('userModal').classList.remove('hidden');
        }

        function openEditModal(user) {
            document.getElementById('modalMode').value = 'edit';
            document.getElementById('modalTargetUsername').value = user.username;
            document.getElementById('modalTitle').textContent = 'Edit User: ' + user.name;
            document.getElementById('modalEntity').value = user.entity;
            document.getElementById('modalName').value = user.name;
            document.getElementById('modalUsername').value = user.username;
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalMaxProcesses').value = user.max_processes || 1;
            document.getElementById('modalDomainQuota').value = user.domain_quota || 0;
            setSelectedPerms(user.permissions || []);
            document.getElementById('userModal').classList.remove('hidden');
        }
        window.openEditModal = openEditModal;

        function closeModal() { document.getElementById('userModal').classList.add('hidden'); }

        async function saveUser() {
            const mode = document.getElementById('modalMode').value;
            const entity = document.getElementById('modalEntity').value.trim();
            const name = document.getElementById('modalName').value.trim();
            const username = document.getElementById('modalUsername').value.trim();
            const password = document.getElementById('modalPassword').value.trim();
            const permissions = getSelectedPerms();
            const maxProcesses = parseInt(document.getElementById('modalMaxProcesses').value) || 1;
            const domainQuota = parseInt(document.getElementById('modalDomainQuota').value) || 0;

            if (!entity || !name || !username) {
                showToast('Entity, Name, and Username are required.', 'error');
                return;
            }
            if (mode === 'add' && !password) {
                showToast('Password is required for new users.', 'error');
                return;
            }

            const url = mode === 'add' ? '/api/manage-users/add' : '/api/manage-users/update';
            const body = { entity, name, permissions, max_processes: maxProcesses, domain_quota: domainQuota };
            
            if (mode === 'add') {
                body.username = username;
                body.password = password;
            } else {
                body.target_username = document.getElementById('modalTargetUsername').value;
                body.new_username = username;
                body.password = password || allUsers.find(u => u.username === body.target_username)?.password || '';
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast(data.message, 'success');
                closeModal();
                loadUsers();
            } catch(e) { showToast('Failed to save user', 'error'); }
        }

        function openDeleteModal(username, name) {
            deleteTarget = username;
            document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${name}" (${username})?`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        window.openDeleteModal = openDeleteModal;

        function closeDeleteModal() { document.getElementById('deleteModal').classList.add('hidden'); deleteTarget = null; }

        async function confirmDelete() {
            if (!deleteTarget) return;
            try {
                const res = await fetch('/api/manage-users/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: deleteTarget})
                });
                const data = await res.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast(data.message, 'success');
                closeDeleteModal();
                loadUsers();
            } catch(e) { showToast('Failed to delete user', 'error'); }
        }

        async function resetQuota(username) {
            try {
                const res = await fetch('/api/manage-users/reset-quota', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username})
                });
                const data = await res.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast(data.message, 'success');
                loadUsers();
            } catch(e) { showToast('Failed to reset quota', 'error'); }
        }
        window.resetQuota = resetQuota;

        loadUsers();
    </script>
</body>
</html>
